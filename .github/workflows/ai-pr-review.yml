name: AI PR Review (Security + Payments)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          gh pr diff "$PR_NUMBER" --repo "$REPO" > pr.diff
          echo "saved=true" >> $GITHUB_OUTPUT

      - name: AI Review
        if: steps.diff.outputs.saved == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          python - << 'PY'
          import os, subprocess, textwrap

          # Read diff (cap size to avoid huge payloads)
          diff = open("pr.diff", "r", encoding="utf-8", errors="ignore").read()
          max_chars = 120000
          if len(diff) > max_chars:
            diff = diff[:max_chars] + "\n\n[Diff truncated for size]\n"

          # Install openai SDK
          subprocess.check_call(["python", "-m", "pip", "install", "--quiet", "openai"])

          from openai import OpenAI
          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

          system = """You are a senior full-stack engineer reviewing a GitHub PR for a tutoring platform.

          Focus on:

          SECURITY (CRITICAL):
          - Secrets/credentials leaks (Supabase service_role keys, API keys, Stripe secrets)
          - Payment validation (Stripe, PayPal invoices, Zelle, scholarships must be server-validated)
          - Checkout URL security (prevent open redirect, only server-returned URLs, allowlist domains)
          - Backend wiring + type safety (enum mapping, validation, null handling)
          - XSS vulnerabilities (dangerouslySetInnerHTML without sanitization)
          - Authentication/authorization bypasses

          PERFORMANCE:
          - Large images not optimized (should use TinyPNG or WebP)
          - Missing lazy loading for images/components
          - Missing memoization (useMemo, useCallback) for expensive operations
          - Unnecessary re-renders in React (check deps arrays)
          - Bundle size concerns (large dependencies)

          SEO:
          - Missing or poor meta title/description
          - Missing canonical tags
          - Missing Open Graph tags (og:title, og:description, og:image)
          - Missing alt text on images
          - Missing structured data (schema.org)

          FONTS:
          - Loading too many font weights/variants (prefer 2-3 max)
          - Missing font-display: swap for better performance
          - Not using system fonts when possible

          ACCESSIBILITY:
          - Missing ARIA labels on interactive elements
          - Missing alt attributes on images
          - Low contrast text (should be WCAG AA compliant)
          - Keyboard navigation issues
          - Missing focus indicators

          TYPE SAFETY:
          - Use of 'any' type (prefer explicit types)
          - Missing null/undefined checks
          - Weak type assertions

          Output grouped as:
          ## üö® Blockers (must fix before merge)
          [Critical issues]

          ## ‚ö° Performance Improvements
          [Performance optimizations]

          ## üîç SEO Improvements
          [SEO enhancements]

          ## ‚ôø Accessibility Improvements
          [Accessibility fixes]

          ## üí° Suggestions
          [Nice-to-have improvements]

          ## ‚úÖ Quick Tests to Run
          [Manual testing recommendations]

          If you see a vulnerability, call it out clearly and propose a fix pattern with code examples.
          """

          user = f"Review this PR diff:\n\n{diff}"

          resp = client.chat.completions.create(
              model="gpt-4.1-mini",
              messages=[
                  {"role":"system","content":system},
                  {"role":"user","content":user},
              ],
              temperature=0.2,
          )

          review = resp.choices[0].message.content.strip()

          body = f"""ü§ñ **AI PR Review (Security + Payments)**

          {review}

          _If this review seems off, reply with ‚Äúrecheck‚Äù and what you changed._
          """

          pr_number = os.environ["PR_NUMBER"]
          repo = os.environ["REPO"]

          # Post a PR comment
          subprocess.check_call(["gh", "pr", "comment", pr_number, "--repo", repo, "--body", body])

          print("Posted AI review comment.")
          PY
